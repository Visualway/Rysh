{% extends 'core/base.html' %}

{% load humanize %}
{% load mention %}

{% block title %}
{{ vit.body | truncatechars_html:50 | safe }}
{% endblock title %}

{% block content %}
<div class="columns">
  <div class="column">
    {% include 'vit/extends/vit_block.html'%}
    <br>

    <div class="columns">

      {% if vit.image %}
      <div class="column">
        <article class="image is-800x600">
          <img src="{{ vit.image.url }}" alt="">
        </article>
      </div>
      {% endif %}

      {% if vit.video %}
      <div class="column">
        <article class="image is-800x600">
          <video src="{{ vit.video.url }}" controls>Your Browser doesn't support Videos</video>
        </article>
      </div>

      {% endif %}
    </div>
    <br>
    <h4 class="title is-4">Comments</h4>
    <!-- Comment form -->
    <form method="POST">
      {% csrf_token %}
      <div class="field">
        <label class="label">Comment</label>
        <div class="media">
          <div class="media-left">
            <figure class="image is-48x48">
              <img src="{{ user.profile.image.url }}" alt="{{user}}" class="is-rounded">
            </figure>
          </div>
          <div class="media-content">
            <div class="field">
              <p class="control">
                <textarea class="textarea" name="body" placeholder="Comment"></textarea>
              </p>
            </div>
            <div class="field">
              <p class="control">
                <button type="submit" class="button is-success">
                  Comment
                </button>
              </p>
            </div>
          </div>
        </div>
        
      </div>
    </form>
    <!-- End comment form -->
    <br>
    <div class="media-content">
      {% for comment in comments %}
      <div class="media">
        <div class="media-left">
          <figure class="image is-48x48">
            <img src="{{ comment.user.profile.image.url }}" alt="{{comment.user}}" class="is-rounded">
          </figure>
        </div>
        <div class="media-content">
          <div class="content">
            <p>
              <strong>{{ comment.user }}</strong>
              <small>{{ comment.created_at | date:"F j, Y, g:i a" }}</small>
              <br>
              {{ comment.body }}
            </p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
      
  </div>

<div class="column is-4">
  {% include 'accounts/extends/side_block.html' %}
</div>
</div>
{% endblock content %}

{% block script %}
<script>
  // Just a simple script which sends the server to like a post
  // for more info please see apps/vit/api.py
  function like_vit(vit_id) {
    fetch(`/api/v1/vit/add_like/?vit_pk=${vit_id}`, {
      method: 'GET',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'type': 'application/json'
      }
    }).then(function (response) {
      return response.json();
    }).then(function (data) {
      if (data.status == 'success') {
        var like_count = document.getElementById('like_count_' + vit_id);
        like_count.innerHTML = data.like_count;
        var like_count = document.getElementById('like_count_' + vit_id);
        like_count.innerHTML = data.likes;
      }
    });
  }
</script>
{% endblock script %}